//@version=6
indicator("pjdhiro — SMA200トレンド v6（緩やか判定・最小）", overlay=true, shorttitle="Trend SMA200 v6")

// --- import ---
import uminomae/pjdhiro_trend_core_v6/2 as core

// --- const（SMA200向けに穏当な初期値） ---
const string VER              = " v6.sma200"
const int    DEF_LEN_TREND    = 200
const int    DEF_LB           = 21          // 差分幅はやや大きめ（滑らか）
const int    DEF_LEN_ATR      = 200         // 正規化も“長め”
const float  DEF_EPS_PPB      = 2.0         // ±2 pips/bar 未満は水平扱い
const float  DEF_THETA_NORM   = 0.04        // slope/ATR の閾値
const float  DEF_HYST         = 1.5         // 戻り側を厳しくする係数
const color  DEF_UP_COLOR     = color.teal
const color  DEF_DOWN_COLOR   = color.red
const color  DEF_SMA_COLOR    = color.orange
const int    DEF_SMA_WIDTH    = 2

// --- input（最小・SMA200専用） ---
int    lenTrend    = input.int(DEF_LEN_TREND, "SMA length (固定=200推奨)"+VER, minval=1)
int    lb          = input.int(DEF_LB,        "Slope lookback (bars)"+VER,    minval=1)
string modeStr     = input.string("ATR正規化", "Threshold mode"+VER, options=["符号＋フラット帯","ATR正規化"])
float  epsPpb      = input.float(DEF_EPS_PPB,   "±Flat帯 (pips/bar) [Mode:符号]", minval=0.0)
int    lenAtr      = input.int(DEF_LEN_ATR,     "ATR length [Mode:正規化]",      minval=1)
float  thetaNorm   = input.float(DEF_THETA_NORM,"Min norm (slope/ATR) [Mode:正規化]", minval=0.0)
bool   confirmedOn = input.bool(true,           "確定足のみで判定"+VER)
float  hyst        = input.float(DEF_HYST,      "ヒステリシス係数 (戻り厳しめ)", minval=1.0)

// --- calc（libは純関数。ヒステリはmainで扱う） ---
int  modeId = modeStr == "符号＋フラット帯" ? 0 : 1
[isUp, isDown, isFlat, slopeP, norm, smaNow] = core.trend_flags_sma200(close, lenTrend, lb, modeId, epsPpb, lenAtr, thetaNorm)

// --- hysteresis（状態を持って粘らせる：main側の責務） ---
var int state = 0
//  1=UP, 0=FLAT, -1=DOWN
int next = state

if confirmedOn and not barstate.isconfirmed
    // 未確定バーは状態を維持（色も固定）
    next := state
else
    if state == 1
        // UP中は戻り閾値を厳しく（hyst>1）
        if modeId == 0
            next := slopeP <=  epsPpb / hyst ? 0 : 1
        else
            next := norm   <=  thetaNorm / hyst ? 0 : 1
    else if state == -1
        // DOWN中の戻りも厳しく
        if modeId == 0
            next := slopeP >= -epsPpb / hyst ? 0 : -1
        else
            next := norm   >= -thetaNorm / hyst ? 0 : -1
    else
        // FLAT → Up/Down は通常閾値
        if modeId == 0
            next := slopeP >  epsPpb ? 1 : slopeP < -epsPpb ? -1 : 0
        else
            next := norm   >  thetaNorm ? 1 : norm   < -thetaNorm ? -1 : 0

state := next

// --- draw（グローバルのみ） ---
plot(core.sma_val(close, lenTrend), title="SMA200", color=DEF_SMA_COLOR, linewidth=DEF_SMA_WIDTH)
barcolor(state == 1 ? DEF_UP_COLOR   : na)
barcolor(state == -1 ? DEF_DOWN_COLOR : na)

// --- debug（必要時のみON：全行コメントで切替） ---
// plot(slopeP, title="slope (pips/bar)")
// plot(norm,   title="slope/ATR")
// plotchar(state==1  ? 1 : na, title="UP",   char='U')
// plotchar(state==-1 ? 1 : na, title="DOWN", char='D')
// plotchar(state==0  ? 1 : na, title="FLAT", char='F')
